name: 打包 Windows 版本

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: # 支持手动触发

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 安装 Python 依赖
      run: |
        python -m pip install --upgrade pip
        pip install python-pptx openpyxl xlrd pyinstaller pywin32

    - name: 下载 Python Embedded Distribution
      shell: powershell
      run: |
        # 下载官方嵌入式 Python（自带 vcruntime140.dll 等运行时）
        $url = "https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip"
        Invoke-WebRequest -Uri $url -OutFile "python_embed.zip"
        Expand-Archive -Path "python_embed.zip" -DestinationPath "python_embed"
        Write-Host "Embedded Python DLLs:"
        Get-ChildItem "python_embed\*.dll" | ForEach-Object { Write-Host "  $($_.Name)" }

    - name: 使用 spec 文件打包
      shell: cmd
      run: |
        pyinstaller build_win.spec

    - name: 复制全部运行时 DLL 到 _internal
      shell: powershell
      run: |
        $internal = "dist\XibaoTool\_internal"

        # 从 Embedded Python 复制所有 DLL 到 _internal
        Get-ChildItem "python_embed\*.dll" | ForEach-Object {
          Copy-Item $_.FullName $internal -Force
          Write-Host "Copied $($_.Name)"
        }

        # 从 Python 安装目录复制额外的 DLL 到 _internal
        $pythonDir = (Get-Command python).Source | Split-Path
        foreach ($pattern in @("vcruntime*.dll", "msvcp*.dll", "ucrtbase.dll", "api-ms-win-crt-*.dll", "api-ms-win-core-*.dll")) {
          Get-ChildItem "$pythonDir\$pattern" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName $internal -Force
            Write-Host "Extra: $($_.Name)"
          }
        }

        Write-Host "`n=== _internal DLLs ==="
        Get-ChildItem "$internal\*.dll" | ForEach-Object { Write-Host "  $($_.Name) ($($_.Length) bytes)" }

    - name: 创建启动脚本
      shell: python
      run: |
        import os
        dist = os.path.join("dist", "XibaoTool")

        with open(os.path.join(dist, "start.bat"), "w", encoding="ascii") as f:
            f.write('@echo off\r\n')
            f.write('cd /d "%~dp0"\r\n')
            f.write('set PATH=%~dp0;%~dp0_internal;%PATH%\r\n')
            f.write('start "" "XibaoTool.exe"\r\n')

        with open(os.path.join(dist, "readme.txt"), "w", encoding="utf-8-sig") as f:
            f.write("=== 喜报生成器 使用说明 ===\r\n\r\n")
            f.write("直接双击【start.bat】即可运行，无需安装任何软件。\r\n")
            f.write("如果 bat 无法运行，请尝试直接双击 XibaoTool.exe。\r\n")
            f.write("注意：请将整个文件夹解压后再运行，不要直接在压缩包内打开！\r\n")

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: XibaoTool-Windows
        path: "dist/XibaoTool/"
        compression-level: 9
